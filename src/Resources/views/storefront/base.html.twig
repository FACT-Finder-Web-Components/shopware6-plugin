{% sw_extends '@Parent/storefront/base.html.twig' %}

{% block base_body_inner %}
  {% block base_body_inner_factfinder_communication %}

{#    {% dump(page.extensions.factfinder.communication) %}#}

    <!--Main FF Web-components Initialisation -->
    <script>
      document.addEventListener(`ffCoreReady`, ({ factfinder, init, initialSearch }) => {

        init({
          ff: {
            url: `{{page.extensions.factfinder.communication.url}}`,
            channel: `{{page.extensions.factfinder.communication.channel}}`,
            apiKey: `{{page.extensions.factfinder.communication.apiKey}}`,
          },
          appConfig: {
            debug: true,
            fieldRoles: {{ page.extensions.factfinder.field_roles|json_encode|raw }},
            formatting: {
              locale: `{{page.extensions.factfinder.communication.currencyCountryCode}}`,
              formatOptions: {
                style: `currency`,
                currency: `{{page.extensions.factfinder.communication.currencyCode}}`,
          },
        },
      },
      });

      //   <?php if(!empty($parameters['add-params'])) : ?>
      //   factfinder.routing.setUrlParamOptionsListener(() => ({
      //     postStringifier: pairs => {
      //       <?php foreach ($parameters['add-params'] as $name => $value) {
      //         /* @noEscape */ echo "pairs.push({ key: `{$name}`, value:  `{$value}` });";
      //       } ?>
      //
      //       return pairs;
      //     },
      //   }));
      //   <?php endif; ?>
      //
      // <?php if(!empty($parameters['parameter-whitelist'])) : ?>
      //   factfinder.routing.setUrlParamOptionsListener(() => ({
      //     allow: [<?= /* @noEscape */ $parameters['parameter-whitelist']; ?>],
      // }));
      //   <?php endif; ?>
      //
        const ffRedirectMapping = JSON.parse('{{ page.extensions.factfinder.redirectMapping|raw }}');

        factfinder.request.before.search(({ searchParams, searchOptions }) => {

          if (ffRedirectMapping.hasOwnProperty(searchParams.query)) {
            window.location = ffRedirectMapping[searchParams.query];

            return;
          }

          if (searchOptions?.requestOptions?.origin?.tagName === `FF-SEARCHBOX`) {
            // <?php if(!empty($parameters['add-params'])) : ?>
            // window.location.href =  `/factfinder/result?query=${searchParams.query}&<?= /* @noEscape */ http_build_query($parameters['add-params']) ?>`;
            // <?php else : ?>
            // window.location.href =  `/factfinder/result?query=${searchParams.query}`;
            // <?php endif; ?>

            window.location.href =  `/factfinder/result?query=${searchParams.query}`;

            // Cancel the pipeline to avoid sending a search request to FactFinder before the redirect is complete.
            return false;
          }
        });
      //

        {% if page.extensions.factfinder.searchImmediate and not page.extensions.factfinder.ssr %}
          const searchParams = factfinder.utils.env.searchParamsFromUrl();
          initialSearch(searchParams, { requestOptions: { origin: `initialSearch` } });
        {% endif %}

      });
    </script>

  {% endblock %}

  {{ parent() }}
{% endblock %}

{% block base_body_script %}
{#  {% block base_script_factfinder_search_redirect %}#}
{#    <script>#}
{#      const ffRedirectMapping = JSON.parse('{{ page.extensions.factfinder.redirectMapping|raw }}');#}

{#      document.addEventListener('before-search', function (event) {#}
{#        const query = event.detail.query;#}

{#        if (ffRedirectMapping.hasOwnProperty(query)) {#}
{#          event.preventDefault();#}
{#          window.location = ffRedirectMapping[query];#}

{#          return;#}
{#        }#}

{#        if (['productDetail', 'getRecords'].lastIndexOf(event.detail.type) === -1) {#}
{#          event.preventDefault();#}
{#          window.location = '{{ path('frontend.factfinder.result') }}' + factfinder.common.dictToParameterString(factfinder.common.encodeDict(event.detail));#}
{#        }#}
{#      });#}

{#      document.addEventListener('ffReady', function (e) {#}
{#        e.eventAggregator.addBeforeHistoryPushCallback(function (res, event, url) {#}
{#          url = url.replace(/filter=CategoryPath[^&]+&?/, '').replace(/order=[^&]+&?/, '').replace(/name=[^&]+&?/g, '');#}
{#          factfinder.communication.Util.pushParameterToHistory(res, url, event);#}
{#          return false;#}
{#        });#}
{#      });#}
{#    </script>#}
{#  {% endblock %}#}

  <script>
    const ffTrackingSettings = JSON.parse('{{ page.extensions.factfinder.trackingSettings|json_encode()|raw }}');

    {% if page.extensions.factfinder.ssr %}
      function generateSid() {
        var length = 30;
        var characterSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        var text = "";

        for (var i = 0; i < length; i++) {
          text += characterSet.charAt(Math.floor(Math.random() * characterSet.length));
        }

        return text;
      }
    {% endif %}

    document.addEventListener('ffCoreReady', ({ factfinder }) => {
      {% if page.extensions.factfinder.ssr == 'ssr' and app.request.attributes.get('_route') == 'frontend.factfinder.result' %}
        const searchResult = {FF_SEARCH_RESULT};

        if (searchResult.hasOwnProperty('records')) {
          factfinder.response.dispatch.ssrSearch(searchResult);
        }
      {% endif %}

      const ffCookies = document.cookie.split('; ').reduce((acc, cookie) => {
        const cookieData = cookie.split('=');
        const [key, value] = cookieData;
        acc[key] = value;

        return acc;
      }, {});

      const clearCookie = (name) => {
        document.cookie = name+'=; Max-Age=-1;';
      }

      if (ffCookies['ff_user_id']) {
        factfinder.config.setFFParams({userId: ffCookies['ff_user_id']});

        if (ffCookies['ff_has_just_logged_in']) {
          clearCookie('ff_has_just_logged_in');
          factfinder.tracking.login([{
            sid: JSON.parse(localStorage.ffwebco).sid,
            userId: factfinder.config.get().ffParams.userId
          }]);
        }
      } else {
        if (ffCookies['ff_has_just_logged_out']) {
          clearCookie('ff_has_just_logged_out');
          //Need to fix in webcomponents
          //Now reset userId is impossible
          // factfinder.config.setFFParams({userId: 'undefined'});
        }
      }

      {% if page.extensions.factfinder.ssr %}
        if (!ffCookies['ffwebc_sid']) {
          const sid = generateSid();
          document.cookie = 'ffwebc_sid=' + sid + '; path=/;';
          factfinder.config.setFFParams({sid: sid});
        } else {
          factfinder.config.setFFParams({sid: ffCookies['ffwebc_sid']});
        }
      {% endif %}
    });
  </script>

  {{ parent() }}
{% endblock %}
